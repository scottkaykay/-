## ICMP

ICMP是IP层的一部分，是一种面向无连接的协议，主要作用在于IP主机和路由器间传递控制消息，ICMP报文结构：8位类型+8位代码+16位检验和+特有内容

确认IP包是否成功达到目标地址\
通知在发送过程中IP包被丢弃的原因

ICMP报文分为查询报文和差错报文，有很多种报文类型，它们的前四个字节的格式是相同的，包含2字节的校验和，1字节的类型（ICMP消息类型），1字节的代码\
· ICMP差错报文都是由路由器发送到源主机的，因为IP数据报里有源主机的IP地址，源主机最需要知道数据是否到达了目标位置。\
· ICMP差错报文只提供传输过程中的差错报告，并没有规定应采取什么样的处理措施，不纠错\
· ICMP差错报文不享有任何优先权，没有特别的可靠性保证措施\
· ICMP差错报文是伴随着抛弃出错的IP数据报产生的

差错报文：

终点不可达：类型3\
ICMP源站抑制报文(类型4)：路由器发生拥塞时，(拥塞判断方法：检查路由器缓存区是否已满，给缓存区输出队列设置一个阈值，判断队列中数据报的个数是否超过阈值，检测输入线路的传输率)，
路由器发送ICMP源站抑制报文，源主机收到报文后降低数据发送速率。\
ICMP重定向报文(类型5)：源主机向目标主机发送IP数据报，源主机的默认路由器是1，源主机先把IP数据报发送到路由器1，路由器1选择路由，发送IP数据报到路由器2.如果路由器1发现路由器2和他在
一个网络中，则告诉源主机可以直接把IP数据报发给路由器2，则路由器1发送ICMP重定向报文，告诉它可以直接把IP数据报送到路由器2.\
超时：类型11\
参数具有二义性，类型12

查询报文：

回送请求和回送应答（类型8或0）：ping命令实现

时间戳请求与应答：确定IP数据报在这两个机器之间来回所需的往返时间

### ping的原理

ping程序用来探测主机到主机之间是否可通信，如果不能ping到某台主机，表明不能和这台主机建立连接，ping使用的是ICMP协议，发送ICMP回送请求消息给目的主机，协议规定目的主机必须返回ICMP回送应答消息
给源主机。源主机在一定时间内收到应答，则认为主机可答。

假定主机A的IP地址是192.168.1.1，主机B的IP地址是192.168.1.2，都在同一子网内，则当你在主机A上运行“Ping 192.168.1.2”后，都发生了些什么：\
·Ping命令会构建一个固定格式的ICMP请求数据包，然后由ICMP协议将这个数据包连同地址“192.168.1.2”一起交给IP层协议 ping能够计算往返时间RTT，它在报文的数据部分插入发送时间\
·IP层协议将以地址“192.168.1.2”作为目的地址，本机IP地址作为源地址，加上一些其他的控制信息，构建一个IP数据包，并在一个映射表（ARP实现  IP地址转成Mac地址的协议）中查找出IP地址192.168.1.2所对应的MAC地址（这是数据链路层协议构建数据链路层的传输单元——帧所必需的），一并交给数据链路层。\
· 数据链路层构建一个数据帧，目的地址是IP层传过来的MAC地址，源地址则是本机的物理地址，还要附加上一些控制信息，依据以太网的介质访问规则，将它们传送出去。\
·主机B收到这个数据帧后，先检查它的目的地址，并和本机的物理地址对比，如符合，则接收；否则丢弃。接收后检查该数据帧，将IP数据包从帧中提取出来，交给本机的IP层协议。同样，IP层检查后，将有用的信息提取后交给ICMP协议，后者处理后，马上构建一个ICMP应答包，发送给主机A，其过程和主机A发送ICMP请求包到主机B一模一样。

