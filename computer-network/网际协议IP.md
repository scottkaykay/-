## IP基础

IP协议处于网络层，网络层的主要作用是实现主机与主机间的通信，即点对点通信。

### 1.与数据链路层的关系

数据链路层的作用是实现**两个直连设备的通信**，IP负责在两个没有直连的网络之间的通信传输。即：**MAC只负责一个区间之间的通信传输，IP负责将数据包发给最终的目的地址。**、
数据包的传输过程中，源IP地址和目标IP地址在传输过程中是不会发生变化的，只有源MAC地址和目的MAC地址会不断变化。

### 2.IP地址相关

每个设备都必须配置正确的IP地址，否则无法正常通信。IPv4地址由32位正整数表示，为方便记忆，采用点分十进制标记，即每8位为一组，共分为4组，每组以.分隔开，再换成十进制。

IP地址最大值为2^32，约为43亿，但是IP地址并不是按照主机数量来配置的，而是以**网卡**来配置的。如路由器，服务器等设备有两个以上的网卡，那么就有两个以上的IP地址。
怎么现在这么多设备都有IP地址，IP地址还够用？采用了**NAT网络地址转换技术**。

i. IP地址分类

5种类型：A,B,C,D,E：\

A类： 0 + 网络号(7bit) + 主机号(24bit)   地址范围：0.0.0.0~127.255.255.255  最大主机数：2^24-2=16777214

B类： 10+ 网络号(14bit) + 主机号(16bit)  地址范围：128.0.0.0~191.255.255.255 最大主机数：2^16-2=65534

C类： 110+网络号(21bit) + 主机号(8bit)   地址范围：192.0.0.0~223.255.255.255 最大主机数：2^8-2=254  以上减2是由于主机号全为0或全为1，**全0指定某个网络，全1指定某个网络下的所有主机，用于广播**

D类： 1110+ 组播地址(28bit)     地址范围： 224.0.0.0~239.255.255.255  IP多播，多播用于将包发送给**特定组内的所有主机**，广播无法穿透路由，若要给其他网段发送同样的包，可使用穿透路由的多播。

E类： 11110+ 后续使用(27bit)    地址范围： 240.0.0.0~255.255.255.255  预留使用

广播地址用于同一个链路中相互连接的主机间发送数据包。广播分为本地广播和直接广播。|
本地广播：在本网络内广播\
直接广播：在不同网络间的广播，直接广播有一定的安全问题，多数情况下路由器设置为不转发。

D类和E类地址是没有主机号的，不能用于主机IP，D类常用于多播，E类是预留的分类，暂时未使用。

D类地址：

· 224.0.0.0~224.0.0.255 为预留的多播地址，智能在局域网中使用，路由器不转发\
· 224.0.1.0~238.255.255.255 为用户可用的组播地址，可用于Internet上\
· 239.0.0.0~239.255.255.255 为本地管理组播地址，可供内部网在内部使用

分类优点：更容易分析网络地址和主机地址\
缺点：同一网络下没有地址层次，缺少地址的灵活性。A,B,C类地址不能与现实网络匹配。C类地址的最大主机数太少，B类的又太大，可通过CIDR无分类地址解决。

ii.无分类地址CIDR

直接将32位IP地址划分为2部分：网络号+主机号，表示形式：a.b.c.d/x /x表示前x位属于网络号，x的范围是0~32，使IP地址更有灵活性。

子网掩码也是划分网络号和主机号的方式，掩盖掉主机号，剩下的就是网络号。将子网掩码和IP地址按位与运算，就可得到网络号。

iii. 为什么要分离主机号和网络号

两台主机要通信，先要判断是不是在同一个广播域内，即网络地址是否相同。如果二者网络地址相同，则二者在一个网络中，可以直接把数据包发送到目标主机。
路由器寻址工作中，也是通过这样的方式来找到对应的网络号的，再把数据包转发到对应的网络内。

iv.如何划分子网

通过子网掩码。子网划分实际上就是将主机地址分为两个部分：**子网网络地址和子网主机地址**。如对网络地址192.168.1.0，使用子网掩码255.255.255.192对其
进行子网划分：根据子网掩码可知从8位主机号中借用2位作为子网号，所以子网就有4个：\
子网号        网络地址\
  0          192.168.1.0
  
  1          192.168.1.64
  
  2          192.168.1.128
  
  3          192.168.1.192
  
  v. 公有IP地址和私有IP地址
  
  私有IP可以自己分配，自己管理，可以重复。公有IP是由国际组织ICANN（互联网名称与数字地址分配机构）统一分配的，公有IP地址是唯一的。

### 3.IP地址与路由控制

IP地址的网络号用于路由控制。主机和路由器各维护一份路由控制表，记录着网络地址和下一步应该发送的路由器的地址。

发送IP数据报时，首先确定目标IP地址，再从路由控制表中找到与该地址具有相同网络地址的记录，根据此记录将数据报发送给相应的下一个路由器。如果路由控制表中有多条相同网络地址的记录，则选择
相同位数最多的网络地址进行发送，即最长匹配。

环回地址：127.0.0.1 用于同一台计算机上不同程序的通信，数据报不会流向网络。

### 4.IP分片与重组

数据链路最大传输单元MTU, 如以太网MTU是1500字节。当IP数据报大小大于MTU时，IP数据报会被分片。**经过分片的IP数据报只能在目标主机重组，路由器不会进行重组工作**。

分片传输中，如果某个分片丢失，整个IP数据报都会作废，所以在TCP层分片。

### 5.IPv6 基本认识

IPv6地址是128位，除了能分配更多的IP地址，还有更好的安全性和扩展性。但是与IPv4不兼容。

·IPv6可自动配置，即使没有DHCP服务器也可实现自动分配IP地址\
·IPv6包头包首部采用固定的40字节，去掉了包头检验和，简化了首部结构，减轻了路由器负荷，大大提升了传输性能。\
·IPv6有应对伪造IP地址的网络安全功能，提升了安全性

IPv6每16位一组，中间用冒号隔开，如果出现连续的0，可以将这些0省略，并用两个冒号隔开，**一个IP地址中只允许出现一次两个连续的冒号**

IPv6地址主要有以下类型：\
· 单播地址： 用于一对一通信，分为链路本地单播地址，唯一本地地址，全局单播地址\
· 组播通信：用于一对多的通信\
· 任播地址：用于通信最近的节点，最近的节点是由路由协议决定\
· 没有广播地址

IPv6取消了首部校验和字段，不允许中间路由器对分组进行分片重组，取消选项字段

### 6.IP协议相关技术

#### DNS域名解析

域名中，越靠右层级越高。根域名服务器，顶级域域名服务器，权威域名服务器。

DNS查询过程：

· 浏览器首先看一下自己的缓存里有没有，如果没有就向操作系统的缓存要，还没有就检查本机域名解析文件 hosts，如果还是没有，就会 DNS 服务器进行查询：\
· 客户端首先会发出一个 DNS 请求，问 www.server.com 的 IP 是啥，并发给本地 DNS 服务器（也就是客户端的 TCP/IP 设置中填写的 DNS 服务器地址）。\
· 本地域名服务器收到客户端的请求后，如果缓存里的表格能找到 www.server.com，则它直接返回 IP 地址。如果没有，本地 DNS 会去问它的根域名服务器：“老大， 能告诉我 www.server.com 的 IP 地址吗？” 根域名服务器是最高层次的，它不直接用于域名解析，但能指明一条道路。 \
· 根 DNS 收到来自本地 DNS 的请求后，发现后置是 .com，说：“www.server.com 这个域名归 .com 区域管理”，我给你 .com 顶级域名服务器地址给你，你去问问它吧。”\
· 本地 DNS 收到顶级域名服务器的地址后，发起请求问“老二， 你能告诉我 www.server.com  的 IP 地址吗？”\
· 顶级域名服务器说：“我给你负责 www.server.com 区域的权威 DNS 服务器的地址，你去问它应该能问到”。\
· 本地 DNS 于是转向问权威 DNS 服务器：“老三，www.server.com对应的IP是啥呀？” server.com 的权威 DNS 服务器，它是域名解析结果的原出处。为啥叫权威呢？就是我的域名我做主。\
· 权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。\
· 本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接。

#### ARP

在传输一个IP数据报的时候，除了需要知道源IP地址和目的IP地址，还要知道下一跳的MAC地址。主机的路由表中可找到下一跳的IP地址，可通过ARP协议获得下一跳的MAC地址。

ARP是借助ARP请求与ARP响应两种类型的包确定MAC地址的。流程：

· 主机广播发送ARP请求，问：这个IP地址是谁的？这个IP地址即下一跳的IP地址\
· 同个链路的所有设备收到ARP请求时，会拆开ARP请求包里的内容，如果里面的目标IP地址和自己的IP地址一致，则这个设备就把自己的MAC地址放入ARP响应包返回给主机。
操作系统会把第一次通过ARP请求获取的MAC地址存储在缓存中，但是是有期限的，过期会被清除。

#### RARP

已知MAC地址求IP地址。如打印机服务器等嵌入式设备接入网络会用到。通常需要架设一台RARP服务器，在该服务器上注册设备的MAC地址和IP地址，并接入到网络。
设备发出查询请求，RARP服务器返回对应的IP地址给设备。

#### DHCP

可以动态获取IP地址，大大省去了配IP信息的繁琐过程。

DHCP客户端进程监听的端口号为68，服务器端进程监听的端口号是67

流程：

· 客户端发起**DHCP发现报文的IP数据报**。由于客户端没有IP地址，也不知道DHCP服务器的地址，所以使用的是UDP广播通信，目的地址全为1，源地址全为0.DHCP客户端将数据报交给数据链路层，将帧广播到所有的网络设备。\
· DHCP服务器收到DHCP发现报文时，用DHCP提供报文响应客户端。该报文依然使用IP广播地址255.255.255.255，该报文信息包含：**可租约的IP地址，子网掩码，默认网关，域名服务器地址，IP地址租用期。**\
· 客户端收到一个或多个服务器的DHCP提供报文，从中选择一个服务器，并向选中的服务器发送DHCP请求报文；\
· 服务端用DHCP ACK报文对DHCP请求进程响应，应答所要求的参数。

一旦客户端收到DHCP ACK后，交互便完成了。客户端能在租用期内使用DHCP分配的IP地址。如果租约的IP地址到期，客户端会向服务器发送DHCP请求报文：\
· 服务器同意继续租用，用DHCP ACK报文应答，客户端就会延长租期。\
· 服务器不同意继续租用，用DHCP NACK报文应答，客户端就要停止使用租约的IP地址。

可以看到，DHCP交互中，全程使用UDP广播通信。如果DHCP服务器和客户端不在一个局域网内，路由器又不转发广播包，怎么办？使用DHCP中继代理。\
使用DHCP中继代理，对不同网段的IP地址分配也可以由一个DHCP服务器管理。流程描述：

· DHCP客户端向DHCP中继代理发送DHCP请求包，DHCP中继代理收到这个广播包后以单播的形式发给DHCP服务器\
· DHCP服务器收到该包后向DHCP中继代理返回应答，由中继代理将此包广播给DHCP客户端。

#### NAT网络地址转换

简单来说，就是主机对外通信时，将私有IP地址转换成公有IP地址。绝大多数网络应用都是使用传输层协议TCP或UDP来传输数据的，所以可以把IP+端口号一起转换。这叫
网络地址与端口转换：NAPT

比如同一网段的不同客户端要同时访问一台服务器，其私有地址转换成公有地址都是一样的 ，以端口号区分。

NAT的缺点：\
· 外部无法主动与NAT内部服务器建立连接，因为NAPT转换表没有转换记录。\
· 转换表的生成与转换操作都会产生性能开销。\
通信过程中如果NAT路由器重启，则所有的TCP连接都将重置。

如何解决？

· 使用IPv6\
· 使用NAT穿透，即客户端主动从NAT设备获取公有IP地址，自己建立端口映射，不用像以前NAT设备来建了。

#### ICMP 互联网控制报文协议

主要功能：确认IP数据报是否成功送达目标地址。报告发送过程中IP数据报被丢弃的原因和改善网络设置

大致分为两种类型：\
· 用于诊断的查询消息，即查询报文类型\
· 通知错误原因的错误消息，即差错报文类型

0： 回送应答，查询报文类型  8：回送请求，查询报文类型\
3： 目标不可达，差错报文类型  4:原点抑制  5：重定向或改变路由  11：超时

#### IGMP 因特网组管理，工作在主机和最后一跳路由器之间

前面说的D类组播地址，只有在一组的主机能收到数据报，不在一组的收不到，如何管理是否在一组？需要IGMP协议

IGMP报文向路由器申请加入和退出组播组，主机申请加入到组播组时，路由器会记录组播成员关系到IGMP路由表，路由器后续就会转发组播包到对应的主机了。\
IGMP报文采用IP封装。
