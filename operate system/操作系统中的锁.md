## 操作系统中不同的锁

### 信号量 Semaphore

信号量分为二元信号量和多元信号量，二元信号量就是信号量只有两个状态，要么被占用，要么空闲；多元信号量则允许同时被N个线程占用，超出N个外的占用请求将被阻塞。比如常见的生产者和消费者，就是多元信号量的一种，生产者可以生产多个元素，消费者可以消费的元素必须小于生产者生产的元素个数。
信号量是系统级别的，即同一个信号量可以被不同的进程访问。

### 互斥量 Mutex

和二元信号量类似，唯一不同的是，**互斥量的获取和释放必须在同一个线程中进行**，如果一个线程去释放一个并不是它占有的互斥量是无效的。信号量是可以由其他线程释放的。

### 临界区 Critical Section

把临界区锁的获取称为进入临界区，而把临界区锁的释放称为离开临界区。临界区是“进程级别的”，它只在本进程的所有线程中可见，哪个线程获取锁，就由哪个线程释放，这点和互斥量类似。

### 读写锁 Read-Write Lock

适用于一个特定的场合。如对于一段线程间访问的数据，如果程序大部分时间都是在读取，只有很少的时间才会写入，使用前面几种锁时，每次读取也是需要申请锁的，这时其他线程就无法对此段数据进行读取，但多线程的读取操作是没有同步问题的，此时设置锁就会影响程序性能，

对于一个读写锁，有两种获取方式：**共享和独占**。如果当前读写锁处于空闲状态，多个线程以共享方式访问该读写锁时都可以成功，如果一个线程以独占的方式访问该读写锁，
它会等待所有的共享访问都结束才能访问成功。读写锁被独占访问的时候，再次共享和独占请求访问该锁都会进入等待状态。

### 条件变量 Condition Variable

条件变量相当于一种通知机制，多个线程可以设置等待该条件变量，一旦另外的线程设置了该条件变量（相当于唤醒了该条件变量），这些等待的线程就可以继续执行了。

## C++线程中的几种锁

包含互斥锁，条件锁，自旋锁，读写锁，递归锁

### 互斥锁

互斥锁是用于控制多线程对共享资源互斥访问的信号量，避免多个线程在某一时刻同时操作共享资源。如线程池中有多个空闲线程和一个任务队列，任何一个线程都要使用互斥锁互斥访问任务队列，避免多个线程同时访问引起错乱。某一时刻只有一个线程可以获得互斥锁，如果其他线程想要获得互斥锁，只能阻塞等待，直到当前线程释放互斥锁。

### 条件锁

条件锁就是条件变量，某一个线程因为某个条件未得到满足，可以使用条件变量使其处于阻塞状态。一旦条件满足以 信号量 的方式唤醒被阻塞的线程。最为常见的就是在线程池中，起初没有任务时任务队列为空，线程池中的线程因为任务队列为空而处于阻塞状态，一旦有任务进来，就会以信号量的方式唤醒一个线程来处理这个任务。这个过程中使用到了条件变量 pthread_cond_t

```C++
pthread_mutex_lock(mutex);//加互斥锁
while(条件不成立)//当前线程中条件变量不成立
{
      pthread_cond_wait(cond, mutex);//解锁，其他线程使条件成立发送信号，加锁。
}
...//对进程之间的共享资源进行操作
pthread_mutex_unlock(mutex);//释放互斥锁
```
pthread_cond_wait函数的语义相当于：首先解锁互斥锁，然后以阻塞方式等待条件变量的信号，收到信号后又会对互斥锁加锁。

为了防止“虚假唤醒”，该函数一般放在while循环体中.

### 自旋锁

如双核CPU,线程A运行在core1上，线程B运行在core2上。
互斥锁是一种sleep-waiting的锁，如果线程A获得了互斥锁，线程B在申请互斥锁时会被阻塞，并放入等待队列，此时core2可以转去执行其他任务而不必等待。\
自旋锁是一种busy-waiting的锁，如果线程A获得了自旋锁，线程B申请自旋锁会失败，但此时core2会不断循环检查锁是否可用，直到获取到这个自旋锁为止。所以相当耗费CPU资源，适用于短时间的轻量级的加锁机制。

### 读写锁



## 信号量和互斥量的区别

程序的可重入：一个程序因为操作系统中断被挂起，当再次进入程序执行的时候可以依旧正确运行。表达一个函数可重入的时候必须包含静态变量和全局变量。
对于那些不可重入的多线程，必须让多个线程进行同步操作。所谓同步，指的是一个线程在访问资源尚未结束的时候，其他线程不可以随意访问并修改数据。

· Mutex是一把钥匙，一个人拿了钥匙进入一个房间，出来的时候把钥匙交给队列的第一个（锁的获取和释放均由同一个线程进行），一般的用法是 **用于串行化对临界区代码的访问，**保证这段代码不会被并发执行。\
· Semaphore是一间可以容纳N个人的房间，如果人不满就可以进去，如果人满了，就要等待有人出来，对于N=1, 称为binary semaphore,一般用于限制对于某一资源的同时访问，有的系统中二元信号量和互斥量是没有差异的。\
· 信号量可以设置计数器，而互斥锁只有0和1 的关系

