## 进程间通信方式

### 管道/匿名管道

管道是半双工的，数据只能朝一个方向上流动，需要双方通信时，要建立两个管道。只能用于父子进程或者兄弟进程间的通信。\
单独构成一种独立的文件系统：对于管道两端的进程而言，管道就是一个文件，但是它不是普通的文件，不属于某种文件系统，只存在于内存中。\
数据的读写：一个进程在管道的一端写入数据，每次写入都添加在管道缓冲区的末尾。另一个进程在管道的另一端读取数据，每次都从管道缓冲区的头部读出。

i. 管道的实质

管道的实质就是一个内核缓冲区。进程以先进先出的方式存储数据，一端的进程按序往缓冲区中写入数据，另一端的进程按序读取数据。每个数据只能读一次，读出来以后在缓冲区就不复存在了。
当缓冲区为空或者满时，读进程或写进程会进入等待队列，直到有数据写入或者有数据读出，再唤醒这些读写进程。

ii. 管道的局限

· 只支持单向数据传输\
· 只能用于具有亲缘关系的进程之间\
· 没有名字\
· 管道的缓冲区大小是有限的\
· 管道传送的是**无格式字节流**，这就要求收发双方需要事先约定号数据格式，如多少个字节算一个消息

### 有名管道

匿名管道由于没有名字，只能用于具有亲缘关系的进程之间，为克服这个缺点，提出了有名管道。\
有名管道提供了一个**路径名与之关联**。以有名管道的文件形式存在于文件系统，这样一来，即使与有名管道的创建进程不存在亲缘关系，进程只要可以访问该路径，
就能够通过彼此的有名管道通信，即不相关的进程也能交换数据。

有名管道也严格遵循先进先出，每次写数据将数据添加到缓冲区末尾，每次读数据从缓冲区的头部读出。**有名管道的名字存放于文件系统，内容存放于内存。**

无名管道在读写时需要确定对方是否存在，有名管道在打开时需要确认对方是否存在。

### 信号

信号是Linux中进程通信或操作的一种机制。信号可以在任何时候发给某进程，不用管该进程的状态。如果进程还未执行，信号就由内核先保存起来，直到该进程恢复执行并传递给它为止。
如果信号被设置为阻塞，则信号的传递被延迟，直到阻塞取消，再传递给进程。

常用信号：\
· SIGHUP:用户从终端注销。所有已启动的进程收到消息并终止。\
· SIGINT:程序终止信号。程序运行时，ctrl+c会产生此信号。\
· SIGQUIT:程序退出信号，程序运行时ctrl+\\会产生此信号。\
· SIGTERM：结束进程信号，执行kill 进程pid时发送该信号
· SIGKILL:用户终止进程执行，执行 kill -9发送该信号

信号是软件层次上对中断的模拟，可在用户空间和内核空间直接交互，内核可利用信号通知用户空间的进程发生了哪些系统事件。信号来源：\
· 硬件来源：ctrl+c\
· 软件终止，SIGTERM,SIGKILL

信号处理流程：\
· 信号被某个进程产生，并设置信号传递的对象（对应进程的PID），然后传递给操作系统\
· 操作系统根据接收进程的设置选择性地发送给接受者（主要看接收进程对该信号是否阻塞）\
· 接收进程收到该信号后，根据当前进程对此信号设置的预处理方式，暂时中止当前代码的执行，保护上下文（临时寄存器数据，CPU状态，当前程序位置），转而执行中断程序，
执行完成后再恢复到中断的位置。

### 消息队列

消息队列是存放在内核中的消息链表，每个消息队列由消息队列**标识符**表示。只有在内核重启或显式删除的时候，消息队列才会被真正删除。
与管道不同的是，消息队列在往队列里写入数据时，**不需要另外一个进程在队列上等待消息的到达**。

特点：

· 消息队列是消息的链表，有特定的格式，存放在内存中，由标识符标识；\
· 消息队列允许一个或多个进程向它进行读写操作；\
· 遵循先进先出原则\
· 可实现消息的随机查询们不一定按照先进先出的次序读取\
· 克服了信号量承载信息少，管道只能承载无格式字节流且缓冲区大小受限的缺点；\
· 目前主要有两种类型的消息队列：POSIX消息队列，System V队列。系统V队列现在被大量使用，随内核持续。

### 共享内存

多个进程可以直接读写同一块内存空间，是最快的IPC方式。为了在多个进程间，交换信息，内核专门留了一块内存区，可以由需要访问的进程将其映射到自己的私有地址空间。
进程就可以直接读写这块内存，不需要数据拷贝，大大提高效率。\
多个进程共享一块内存，需要通过同步机制达到进程间的同步与互斥。

### 信号量

实质是一个计数器，用于多进程对共享数据的访问。其意图在于进程间同步。

为获得共享资源，进程需要执行如下操作：\
· 创建信号量，并指定初值\
· 等待一个信号量：该操作会测试这个信号量的值，如果小于0，则阻塞（也叫P操作）\
· 挂出一个信号量：该操作将信号量的值加1，即V操作

信号量和普通整形变量的区别：\
· 信号量是非负整型变量，除初始化之外，只能通过两个原子操作（wait,signal）来访问\
· 操作被称为PV操作，普通整型变量可在任何语句块中被访问。

信号量与互斥量的区别：\
· 信号量用于线程同步，互斥量用于线程互斥。\
互斥：对于某个共享资源，同一时间只允许一个访问者对其访问。具有排他性和唯一性，但无法限制访问者的访问顺序。\
同步：在互斥的基础上，通过其它机制实现访问者对资源的有序访问。

· 互斥量只能为0/1, 信号量为非负整数
· 互斥量的加锁解锁必须由同一线程对应使用，信号量可以由一个线程释放，另一个线程获取。

### socket套接字

可以实现不同主机间的进程通信。套接字的特性由3个属性确定：域，端口号，协议类型

i. 套接字的域

套接字的域指定了通信所采用的网络介质，常用的有2种：

· AF_INET. 代表互联网网络。服务器必须在通信开始之前绑定一个端口，并在端口等待客户的连接。\
· AF_UNIX. 表示UNIX文件系统，它就是文件输入/输出，它的地址就是文件名。

ii.套接字的端口号

每个基于TCP/IP协议通讯的进程都会被赋予一个唯一的端口和端口号。端口是一个信息缓冲区，用来保存插槽中的输入输出信息。端口号是一个16位无符号整数，范围0~65535，可区别主机上的不同程序。IP+端口号可区别不同的套接字。

iii.socket协议类型

因特网提供三种协议机制：

· 流套接字。在域中使用TCP/IP协议连接，是AF_UNIX的常用套接字类型。流套接字提供的是有序，可靠，双向的字节流的连接\
· 数据报套接字。不需要建立和维持一个连接，在域中使用UDP/IP协议连接，可以对发送数据的长度有限制，在不建立连接的情况下直接发送数据报，但可能会丢失。\
· 原始套接字。允许对较低层次的协议直接访问，如IP,ICMP协议。常用于检验新的协议的实现。原始套接字可以读取**内核中没有处理的IP数据包**，刘涛及诶这可以只能读取TCP协议的数据，数据包套接字只能读取UDP协议的数据。如果要访问其他协议发送数据，必须使用原始套接字。

套接字通信建立过程：

客户端：创建套接字，初始化套接字，Connect发送连接请求。\
服务端：创建套接字，绑定套接字，监听端口，接收连接请求

socket():生成一个用于通信的套接字文件描述符。但没有和任何IP，端口相关联\
bind():将套接字绑定到要监听的IP+端口。当处于监听状态时，还属于监听套接字（包含源端口，源IP地址，协议类型三个信息），如果通过三次握手建立了连接，则成为专用连接套接字（多了客户端的端口和IP，序列号）

TCP之所以称为可靠连接就是因为包含序列号和确认号。
