## 虚拟内存

https://blog.csdn.net/shellquery/article/details/100893040

操作系统完成由虚拟内存地址到真实内存地址或磁盘地址之间的映射工作，这样给用户提供的虚拟内存的地址空间就会非常大，用户程序中那些很久都用不到的内存空间可以被操作系统存在磁盘上，什么时候需要用了，再从磁盘中加载到真实内存。

虚拟内存结构：

内核：      操作系统代码和数据

               栈空间
               
               
               堆空间
               
               用户进程代码和数据（代码区，常量区，全局/静态存储区）
               
 ## Linux 虚拟内存 以x86架构的32位Linux系统为例
 
 Linux采用虚拟内存技术，让每个进程都有4GB的互不干涉的虚拟地址空间。进程初始化分配和操作都是基于这个虚拟地址，只有进程需要实际访问内存资源的时候，才会**建立虚拟地址和物理地址的映射，调入物理内存页。**
 
 ### 虚拟地址的好处：
 
 · 避免用户直接访问物理内存地址，防止一些破坏性操作\
 · 每个进程都被分配了4G的虚拟内存，用户程序可使用比实际物理内存更大的地址空间
 
 4G的进程虚拟地址空间分为两部分：用户空间和内核空间，其中用户空间占3G，内核空间占1G
 
 ### 物理地址
 
 不管是用户空间还是内核空间，使用的都是虚拟地址，当进程需要实际访问内存的时候，会由内核的 请求分页机制 产生缺页异常 调入物理内存页。把虚拟地址转换成内存的物理地址，涉及利用MMU内存管理单元，对虚拟地址
 分段和分页地址转换。如段页式内存管理地址转换：\
 逻辑地址  ------------------>   分段机制 ----------------------> 线性地址----------------------> 分页机制----------------------> 物理地址
 
 物理内存可分为3个管理区：\
 · DMA 内存区域。0~16MB的内存页框，直接映射到内核地址空间\
 · 普通内存区域： 16~896MB， 直接映射到内核的地址空间\
 · 高端内存区域，896MB以上的内存页框，不进行直接映射，可通过永久映射和临时映射进行这部分内存页框的访问
 
 ### 用户空间
 
 **用户进程**访问的是用户空间，每个进程都有自己独立的用户空间，虚拟地址范围为0x00000000~ 0xBFFFFFFF, 总容量3G，只有执行系统调用或硬件中断醋能访问内核空间
 
 用户空间按照访问属性一致的地址空间存放在一起的原则，划分成5个不同的内存区域，访问属性指的是“可读，可写，可执行”
 
 代码段：用来存放可执行文件的操作指令，可执行文件在内存中的镜像，要防止运行时被非法修改，所以是只读的。\
 数据段：存放可执行文件中已初始化的全局变量，即存放程序的静态变量和全局变量\
 BSS段：包含了程序中未初始化的全局变量，在内存中BSS段全部置零\
 堆：存放进程运行中动态分配的内存段，大小不固定，可动态扩张或缩减，当进程调用malloc等函数分配内存时，新分配的内存就被动态添加到堆上，当利用free等函数释放内存时，被释放的内存从堆中被剔除\
 栈：存放程序临时创建的局部变量，除此之外，函数被调用时，其参数也会被压入发起调用的进程栈中，并且待到调用结束后，函数的 返回值也会被存放回栈中，由于栈的先进后出特点，特别适合于保护现场恢复调用现场，，位置上，
 代码段和栈会被独立存放
 
 ### 内核空间
 
 虚拟地址范围为 0xC0000000~ 0XFFFFFFFF, 一共1G，可分为：\
 · 直接映射区： 从起始地址开始，最大896M的内核空间地址区间，即线性地址和分配的物理地址都是连续的，它们之间相差一个偏移量\
 · 高端内存线性地址空间：128M，又分为动态内存映射区，永久内存映射区，固定映射区
 
 · 动态内存映射区：该区域由内核函数vmalloc来分配，特点是：线性地址是连续的，物理地址不一定连续，vmalloc分配的线性地址所对应的物理页可能处于低端内存，也可能处于高端内存。
 
 · 永久内存映射区：该区域可访问高端内存，访问方法：使用 alloc_page (_GFP_HIGHMEM) 分配高端内存页或使用kmap函数将分配到的高端内存映射到该区域
 
 · 固定映射区：该区域和4G的顶端只有4K的隔离带，其每个地址项都服务于特定的用途
 
 ### 用户空间内存数据结构
 
 用户空间可划分为5个不同的内存区域：代码段，数据段，BSS段，堆，栈。将这些内存区域抽象成vm_area_struct的内存管理对象。vm_area_struct是描述进程地址空间的基本管理单元，一个进程地址空间往往往往需要多个vm_area_struct来描述，这些结构体之间
 使用链表或红黑树来组织。链表在需要遍历全部节点的时候用，红黑树用于在地址空间定位特定区域，内核为了内存区域上的各种不同操作都能获得高性能，所以同时使用了这两种数据结构。
 
### 内核空间的内存数据结构
 
 动态内存映射区：vmalloc分配的地址限于  vmalloc_start与vmalloc_end之间。每一块vmalloc分配的虚拟内存对应一个vm_struct结构体。不同内核空间虚拟地址之间有4K大小的防越界空闲区间隔区。与用户空间的虚拟地址特性一样，这些虚拟地址与物理内存没有简单的映射关系，
 必须通过内核页表才能转换为物理地址或物理页，它们有可能未被映射，当发生缺页时才真正分配物理页面。
